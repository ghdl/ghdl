name: Auto-generating and assembling main documentation (Sphinx)

on:
  workflow_call:
    inputs:
      ubuntu_image:
        description: 'Name of the Ubuntu image.'
        required: false
        default: 'ubuntu-24.04'
        type: string
      ghdl_artifact:
        description: 'Name of the GHDL artifact for Ubuntu.'
        required: true
        type: string
      python_version:
        description: 'Python version.'
        required: false
        default: '3.12'
        type: string
      requirements:
        description: 'Python dependencies to be installed through pip.'
        required: false
        default: '-r doc/requirements.txt'
        type: string
      doc_directory:
        description: 'Path to the directory containing documentation (Sphinx working directory).'
        required: false
        default: 'doc'
        type: string
      html_artifact:
        description: 'Name of the HTML documentation artifact.'
        required: false
        default: ''
        type: string
      latex_document:
        description: 'LaTeX root document without *.tex extension.'
        required: true
        type: string
      latex_artifact:
        description: 'Name of the LaTeX documentation artifact.'
        required: false
        default: ''
        type: string
      pdf_artifact:
        description: 'Name of the PDF documentation artifact.'
        required: false
        default: ''
        type: string

jobs:
  Sphinx:
    name: 'ğŸ““ Sphinx to LaTeX and HTML'
    runs-on: ${{ inputs.ubuntu_image }}

    if: inputs.html_artifact != '' || inputs.latex_artifact != ''

    steps:
      - name: 'â¬ Checkout'
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download artifacts '${{ inputs.ghdl_artifact }}' from 'Build' job
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.ghdl_artifact }}
          path: install

      - name: Install GHDL (chmod) and prepare test environment
        run: |
          chmod +x ./install/bin/*
          cp -r -v ./install/lib/* pyGHDL/lib
          sudo xargs --no-run-if-empty -a ./install/ubuntu.requirements -- apt-get install -y --no-install-recommends
          echo "PATH=$(pwd)/install/bin:$PATH" >> $GITHUB_ENV

      - name: Version check
        run: |
          echo "which ghdl: $(which ghdl)"
          ghdl version

      - name: 'ğŸ Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: 'ğŸ”§ Install dependencies'
        run: |
          sudo xargs --no-run-if-empty -a ./doc/ubuntu.requirements -- apt-get install -y --no-install-recommends
          python -m pip install --disable-pip-version-check ${{ inputs.requirements }}

      - name: 'ğŸ““ Compile HTML documentation'
        if: inputs.html_artifact != ''
        run: |
          cd ${{ inputs.doc_directory }}
          make html

      - name: 'ğŸ““ Compile LaTeX documentation'
        if: inputs.latex_artifact != ''
        run: |
          cd ${{ inputs.doc_directory }}
          make latex

      - name: 'ğŸ“¤ Upload artifact: HTML'
        uses: actions/upload-artifact@v4
        if: inputs.html_artifact != ''
        with:
          name: ${{ inputs.html_artifact }}
          path: doc/_build/html

      - name: 'ğŸ“¤ Upload artifact: LaTeX'
        uses: actions/upload-artifact@v4
        if: inputs.latex_artifact != ''
        with:
          name: ${{ inputs.latex_artifact }}
          path: doc/_build/latex

  LaTeX:
    name: ğŸ““ Converting LaTeX Documentation to PDF
    runs-on: ${{ inputs.ubuntu_image }}
    needs:
      - Sphinx

    if: inputs.latex_artifact != '' && inputs.pdf_artifact != ''

    steps:
      - name: ğŸ“¥ Download artifacts '${{ inputs.latex_artifact }}' from 'Sphinx' job
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.latex_artifact }}
          path: latex

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@master
        with:
          working_directory: latex
          root_file: ${{ inputs.latex_document }}.tex

      - name: ğŸ“¤ Upload 'PDF Documentation' artifact
        uses: actions/upload-artifact@v4
        if: inputs.pdf_artifact != ''
        with:
          name: ${{ inputs.pdf_artifact }}
          path: ${{ inputs.document }}.pdf
          if-no-files-found: error
          retention-days: 1
