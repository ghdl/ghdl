name: Packaging pyGHDL with libghdl (standalone)

on:
  workflow_call:
    inputs:
      os_name:
        description: 'Name of the OS.'
        required: true
        type: string
      os_image:
        description: 'Name of the OS image.'
        required: true
        type: string
      python_icon:
        description: 'Name of the OS image.'
        required: true
        type: string
      python_version:
        description: 'Python version to use for p√ºackaging.'
        required: true
        type: string
      backend:
        description: 'Name of the GHDL backend.'
        required: false
        default: 'mcode'
        type: string
      libghdl_artifact:
        description: 'Name of the libghdl artifact.'
        required: true
        type: string
      pyghdl_artifact:
        description: 'Name of the pyghdl artifact.'
        required: true
        type: string
      unittest_xml_artifact:
        description: 'Name of the pyghdl artifact.'
        required: false
        default: 'pyGHDL-unittest-xml'
        type: string
      coverage_config:
        description: 'Name of the pyghdl artifact.'
        required: false
        default: ''
        type: string
      coverage_sqlite_artifact:
        description: 'Name of the pyghdl artifact.'
        required: false
        default: ''
        type: string
      coverage_xml_artifact:
        description: 'Name of the pyghdl artifact.'
        required: false
        default: ''
        type: string
      coverage_json_artifact:
        description: 'Name of the pyghdl artifact.'
        required: false
        default: ''
        type: string
      coverage_html_artifact:
        description: 'Name of the pyghdl artifact.'
        required: false
        default: ''
        type: string

jobs:
  Package:
    name: 'üêç${{ inputs.python_icon }} Package pyGHDL for ${{ inputs.os_name }} and Python ${{ inputs.python_version }}'
    runs-on: ${{ inputs.os_image }}
    outputs:
      pyghdl_artifact: ${{ inputs.pyghdl_artifact }}

    steps:
      - name: 'üß∞ Checkout'
        uses: actions/checkout@v4

      - name: 'üêç Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: 'üîß Install dependencies'
        run: |
          python -m pip install --disable-pip-version-check "pyTooling[packaging]" wheel

      - name: üì• Download artifacts '${{ inputs.libghdl_artifact }}-${{ inputs.backend }}' from 'Build' job
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.libghdl_artifact }}-${{ inputs.backend }}
          path: install

      - name: Copy libghdl files
        run: |
          cp -Recurse install/lib/* pyGHDL/lib

      - name: üî® Build Python package (binary distribution - wheel)
        run: python setup.py bdist_wheel

      - name: 'üì§ Upload artifact: ${{ inputs.pyghdl_artifact }}'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.pyghdl_artifact }}
          path: dist/pyGHDL*.whl
          if-no-files-found: error

  Test:
    name: 'üêç${{ inputs.python_icon }} Test pyGHDL on ${{ inputs.os_name }} and Python ${{ inputs.python_version }}'
    runs-on: ${{ inputs.os_image }}
    needs:
      - Package

    steps:
      - name: 'üß∞ Checkout'
        uses: actions/checkout@v4
        with:
          path: ghdl

      - name: Prepare testsuite
        run: |
          mkdir pyGHDL
          cp ghdl\pyGHDL\requirements.txt pyGHDL
          mkdir pyGHDL\cli
          cp ghdl\pyGHDL\cli\requirements.txt pyGHDL\cli
          mkdir pyGHDL\dom
          cp ghdl\pyGHDL\dom\requirements.txt pyGHDL\dom
          mkdir pyGHDL\libghdl
          cp ghdl\pyGHDL\libghdl\requirements.txt pyGHDL\libghdl
          mkdir pyGHDL\lsp
          cp ghdl\pyGHDL\lsp\requirements.txt pyGHDL\lsp
          cp -Recurse ghdl\testsuite .

          Remove-Item -Force -Recurse ghdl

      - name: 'üêç Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: üì• Download artifacts '${{ inputs.pyghdl_artifact }}' from 'Package' job
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.pyghdl_artifact }}
          path: wheels

      - name: 'üîß Install dependencies'
        run: |
          python -m pip install -v --disable-pip-version-check (Get-Item .\wheels\pyGHDL-*.whl).FullName
          python -m pip install --disable-pip-version-check -r testsuite\requirements.txt

      - name: List pyGHDL installation directory
        run: |
          tree /F /A ${env:Python3_ROOT_DIR}\Lib\site-packages\pyGHDL

      - name: Sanity check ghdl-lsp
        run: |
          echo "Testing Python module:"
          python -m pyGHDL.cli.lsp --version

          echo ""
          echo "Testing entrypoint (executable):"
          ghdl-ls --version

      - name: Sanity check ghdl-dom
        run: |
          echo "Testing Python module:"
          python -m pyGHDL.cli.dom version

          echo ""
          echo "Testing entrypoint (executable):"
          ghdl-dom version

      - name: 'üö¶ Testsuite: pyunit'
        run: |
          $PYTEST_ARGS = if ("${{ inputs.unittest_xml_artifact }}") { "--junitxml=report/unit/TestReportSummary.xml" } else { "" }
          if ("${{ inputs.coverage_config }}") {
            Write-Host "coverage run --data-file=.coverage --rcfile=pyproject.toml -m pytest -raP --color=yes testsuite/pyunit"
            coverage run --data-file=.coverage --rcfile=pyproject.toml -m pytest -raP $PYTEST_ARGS --color=yes testsuite/pyunit
          } else {
            Write-Host "python -m pytest -raP $PYTEST_ARGS --color=yes testsuite/pyunit"
            python -m pytest -raP $PYTEST_ARGS --color=yes testsuite/pyunit
          }

      - name: Convert coverage to XML format (Cobertura)
        if: inputs.coverage_xml_artifact != ''
        continue-on-error: true
        run: coverage xml --data-file=.coverage

      - name: Convert coverage to JSON format
        if: inputs.coverage_json_artifact != ''
        continue-on-error: true
        run: coverage json --data-file=.coverage

#      - name: Convert coverage to HTML format
#        if: inputs.coverage_html_artifact != ''
#        continue-on-error: true
#        run: |
#          coverage html --data-file=.coverage -d ${{ steps.getVariables.outputs.coverage_report_html_directory }}
#          rm ${{ steps.getVariables.outputs.coverage_report_html_directory }}/.gitignore

# Upload artifacts

      - name: üì§ Upload 'TestReportSummary.xml' artifact
        if: inputs.unittest_xml_artifact != ''
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.unittest_xml_artifact }}-${{ inputs.python_version }}
          path: report/unit/TestReportSummary.xml
          if-no-files-found: error
          retention-days: 1

#      - name: üì§ Upload 'Unit Tests HTML Report' artifact
#        if: inputs.unittest_html_artifact != ''
#        continue-on-error: true
#        uses: actions/upload-artifact@v4
#        with:
#          name: ${{ inputs.unittest_html_artifact }}-${{ inputs.python_version }}
#          path: ${{ steps.getVariables.outputs.unittest_report_html_directory }}
#          if-no-files-found: error
#          retention-days: 1

      - name: üì§ Upload 'Coverage SQLite Database' artifact
        if: inputs.coverage_sqlite_artifact != ''
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.coverage_sqlite_artifact }}-${{ inputs.python_version }}
          path: .coverage
          if-no-files-found: error
          retention-days: 1

#      - name: üì§ Upload 'Coverage XML Report' artifact
#        if: inputs.coverage_xml_artifact != ''
#        continue-on-error: true
#        uses: actions/upload-artifact@v4
#        with:
#          name: ${{ inputs.coverage_xml_artifact }}-${{ inputs.python_version }}
#          path: ${{ steps.getVariables.outputs.coverage_report_xml }}
#          if-no-files-found: error
#          retention-days: 1

#      - name: üì§ Upload 'Coverage JSON Report' artifact
#        if: inputs.coverage_json_artifact != ''
#        continue-on-error: true
#        uses: actions/upload-artifact@v4
#        with:
#          name: ${{ inputs.coverage_json_artifact }}-${{ inputs.python_version }}
#          path: ${{ steps.getVariables.outputs.coverage_report_json }}
#          if-no-files-found: error
#          retention-days: 1

#      - name: üì§ Upload 'Coverage HTML Report' artifact
#        if: inputs.coverage_html_artifact != ''
#        continue-on-error: true
#        uses: actions/upload-artifact@v4
#        with:
#          name: ${{ inputs.coverage_html_artifact }}-${{ inputs.python_version }}
#          path: ${{ steps.getVariables.outputs.coverage_report_html_directory }}
#          if-no-files-found: error
#          retention-days: 1
