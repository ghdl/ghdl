name: Test

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  CI: true
  DOCKER_BUILDKIT: 1

jobs:

# Convention for the names:
# lin, osx, win, msys2: build package for the platform
# *-test: test on the platform

#
# Generate and upload doc
#
  gnatdoc:
    name: 'ğŸ“š gnatdoc'
    runs-on: ubuntu-latest

    steps:
      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3

      - name: 'ğŸ“š Run gnatdoc'
        run: |
          docker run --rm -i -v $(pwd):/src -w /src ghdl/debug:base <<'EOF'
          #!/usr/bin/env sh
          ./configure --enable-werror && make && make install
          gnatdoc -P./ghdl
          EOF

      - name: 'ğŸ“¤ Upload artifact: gnatdoc'
        uses: actions/upload-artifact@v3
        with:
          name: gnatdoc
          path: gnatdoc

#
# Upload Build The Doc
#
  doc:
    needs: gnatdoc
    name: 'ğŸ““ Docs'
    runs-on: ubuntu-latest

    steps:

      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3

      - name: 'â›´ Build ghdl/doc'
        run: |
          docker build -t ghdl/doc . -f- <<-EOF
          FROM ghdl/build:doc
          COPY . /opt/ghdl
          RUN cd /opt/ghdl && ./configure --enable-werror && make && make install
          EOF

      - name: 'ğŸ“¥ Download artifact: gnatdoc'
        uses: actions/download-artifact@v3
        with:
          name: gnatdoc
          path: public/gnatdoc

      - name: 'ğŸ““ BuildTheDocs (BTD)'
        uses: buildthedocs/btd@v0
        with:
          token: ${{ github.token }}
          skip-deploy: ${{ github.event_name == 'pull_request' }}

      #- run: nroff -man doc/_build/man/ghdl.1

      - name: 'ğŸ“¤ Upload artifact: HTML, LaTeX and man'
        uses: actions/upload-artifact@v3
        with:
          name: doc
          path: |
            doc/_build/html
            doc/_build/latex
            doc/_build/man

#
# pyGHDL Bindings, Formatting and pure wheel
#
  pyGHDL:
    name: 'ğŸ pyGHDL'
    runs-on: ubuntu-latest

    steps:
      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3

      - name: 'ğŸ Setup Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 'ğŸ”§ Install dependencies'
        run: |
          sudo apt update -qq
          sudo apt install -y gnat
          python -m pip install --disable-pip-version-check black wheel pyTooling

      - name: 'ğŸš§ Update Python bindings'
        run: ./scripts/update_py_bindings.sh

      - name: 'ğŸš¦ Check if Python bindings changed'
        run: |
          git diff --stat
          echo "NOTE: Bindings can be updated by executing ./scripts/update_py_bindings.sh (see previous step)"
          git diff --exit-code

      - name: 'ğŸš¦ Check if python follows code formatting standards'
        run: python -m black --check pyGHDL

      - name: ğŸ”¨ Build Python package (source distribution)
        run: python setup.py sdist

      - name: ğŸ”¨ Build Python package (binary distribution - wheel)
        run: python setup.py bdist_wheel

      - name: 'ğŸ“¤ Upload artifact: pyGHDL'
        uses: actions/upload-artifact@v3
        with:
          name: pyGHDL
          path: dist/
          if-no-files-found: error

#
# GPL
#

  gpl:
    if: false
    name: 'ğŸš§ğŸš¦ğŸ§ GPL mcode'
    runs-on: ubuntu-latest

    steps:

      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3

      - run: TASK=bullseye+mcode ./scripts/ci-run.sh -c --gplcompat

#
# Build for GNU/Linux
#
  lin:
    name: 'ğŸš§ğŸš¦ğŸ§ Ubuntu ${{ matrix.os }} ${{ matrix.backend }}'
    runs-on: ubuntu-${{ matrix.os }}.04

    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: 20, backend: mcode }
          - { os: 22, backend: mcode }
          - { os: 20, backend: llvm-10 }
          - { os: 22, backend: llvm-14 }
          - { os: 20, backend: gcc-9.3.0 }
          - { os: 22, backend: gcc-12.1.0 }

    steps:
      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3

      - name: 'ğŸ›³ Build and test GHDL in containers'
        run: |
          TASK=ubuntu${{ matrix.os }}+${{ matrix.backend }} ./scripts/ci-run.sh -c
          mv ghdl-*-ubuntu${{ matrix.os }}-*.tgz ghdl-gha-ubuntu-${{ matrix.os }}.04-$(echo ${{ matrix.backend }} | sed 's#-.*##g').tgz

      - name: 'ğŸ“¤ Upload artifact: package'
        uses: actions/upload-artifact@v3
        with:
          name: ubuntu${{ matrix.os }}-${{ matrix.backend }}
          path: ghdl-gha-ubuntu-*.tgz
          if-no-files-found: error

#
# Build for MacOS
#
  osx:
    name: 'ğŸš§ğŸš¦ğŸ macOS ${{ matrix.os }} ${{ matrix.backend }}'
    runs-on: 'macOS-${{ matrix.os }}'

    strategy:
      fail-fast: false
      matrix:
        os:
        - '11'
#        - '12' # issue1897 fails.  Maybe test 11 build on 12.
        backend:
          - mcode
          - llvm

    steps:
      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3

      - name: 'ğŸ’¾ Cache gnat'
        id: cache-gnat
        uses: actions/cache@v3
        with:
          path: gnat
          key: ${{ runner.os }}-gnat

      # Although we cache this, we let the script run to check if the cache is valid (without conditions)
      - name: 'âš™ Dependencies (brew)'
        run: ./scripts/macosx/install-ada.sh

      - name: 'ğŸš§ Build and ğŸš¦ Test GHDL'
        run: |
          PATH=$PWD/gnat/bin:$PATH:/usr/local/Cellar/llvm@14/14.0.6/bin/
          ./scripts/ci-run.sh -c
          mv ghdl-*.tgz ghdl-macos-${{ matrix.os }}-${{ matrix.backend }}.tgz
        env:
          TASK: macosx+${{ matrix.backend }}
          GITHUB_OS: ${{ runner.os }}
          MACOSX_DEPLOYMENT_TARGET: '10.14'

      - name: 'ğŸ“¤ Upload artifact: package'
        uses: actions/upload-artifact@v3
        with:
          name: macos${{ matrix.os }}-${{ matrix.backend }}
          path: ghdl-macos-${{ matrix.os }}-${{ matrix.backend }}.tgz
          if-no-files-found: error

#
# Pure Windows Build (on MSYS2) - create zip (and also pre-wheel zip)
#
  win:
    name: 'ğŸš§${{ matrix.icon }} ${{ matrix.sys }} (pure-build)'
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - {icon: 'ğŸŸª', pkg: 'mcode', sys: 'MINGW32', arch: 'i686' }
#          - {icon: 'ğŸŸ¦', pkg: 'mcode', sys: 'MINGW64', arch: 'x86_64' } #! simulation with mcode is not yet supported on win64
          - {icon: 'ğŸŸ¨', pkg: 'mcode', sys: 'UCRT64', arch: 'ucrt-x86_64'  } #! experimental; simulation with mcode is not yet supported on win64

    env:
      MINGW_ARCH: ${{ matrix.sys }}
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: '${{ matrix.icon }} Setup MSYS2'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          update: true
          install: base-devel git mingw-w64-${{matrix.arch}}-gcc-ada mingw-w64-${{matrix.arch}}-zlib zip
          pacboy: >
            toolchain:p
            python-pip:p

      - name: 'âš™ git config'
        run: git config --global core.autocrlf input
        shell: bash

      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3
        with:
          # The command 'git describe' (used for version) needs the history.
          fetch-depth: 0

      - name: 'ğŸš§ Build package'
        run: |
          pip3 install pefile
          mkdir builddir
          cd builddir
          ../configure --prefix='/GHDL' LDFLAGS="-static -Wl,--stack=8388608" --enable-libghdl
          make
          mkdir -p 'GHDL'
          make install DESTDIR=.
          # No need to add dll dependencies for ghdl, as it is compiled
          # with -static
          make python-wheel
          zip pre-wheel-${{matrix.sys}}.zip -r dist-wheel setup-standalone.py
          zip ghdl-${{matrix.sys}}.zip -r GHDL

      - name: 'ğŸ“¤ Upload artifact: pre-wheel'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.sys }}-pre-wheel
          path: |
            builddir/pre-wheel-${{matrix.sys}}.zip

      - name: 'ğŸ“¤ Upload artifact: zip pure-win'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.sys }}-zip-win
          path: |
            builddir/ghdl-${{matrix.sys}}.zip

#
# Create pure-Windows CPython pyGHDL platform wheel (from the pre-wheel zip)
#
  win-wheel:
    name: 'ğŸš¦ğŸ${{ matrix.icon }} ${{ matrix.sys }} (pyGHDL-wheel)'
    runs-on: windows-latest

    needs:
      - win

    strategy:
      fail-fast: false
      matrix:
        include:
          - {icon: 'ğŸŸª', sys: 'MINGW32', pyarch: x86 }
#          - {icon: 'ğŸŸ¦', sys: 'MINGW64', pyarch: x64 }
          - {icon: 'ğŸŸ¨', sys: 'UCRT64',  pyarch: x64 }

    defaults:
      run:
        shell: pwsh

    steps:
      - name: 'ğŸ Setup Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: ${{ matrix.pyarch }}

      - name: 'ğŸ“¥ Download artifact: package'
        uses: actions/download-artifact@v3
        with:
          path: artifact
          name: ${{ matrix.sys }}-pre-wheel

      - name: 'ğŸ Build python wheel'
        run: |
          pip3 install wheel
          pip3 install pyTooling
          unzip artifact/pre-wheel-${{ matrix.sys }}.zip
          python3 ./setup-standalone.py bdist_wheel
          dir dist

      - name: 'ğŸ Sanity check of the python wheel'
        run: |
          pip3 install -v (get-item dist\pyGHDL-*.whl)
          dir -r ${env:Python3_ROOT_DIR}\Lib\site-packages\pyGHDL
          python3 -m pyGHDL.cli.lsp --version
          python3 -m pyGHDL.cli.dom version

      - name: 'ğŸ“¤ Upload artifact: wheel'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.sys }}-wheel
          path: |
            dist/pyGHDL-*.whl

      - name: '${{ matrix.icon }} Setup MSYS2'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          update: true

#
# Windows Test of standalone zip
#
  win-test:
    name: 'ğŸš¦ğŸğŸ¥¡${{ matrix.icon }} ${{ matrix.sys }} (test sa)'
    runs-on: windows-latest

    needs:
      - win

    strategy:
      fail-fast: false
      matrix:
        include:
          - {icon: 'ğŸŸª', sys: 'MINGW32' }
#          - {icon: 'ğŸŸ¦', sys: 'MINGW64' } #! simulation with mcode is not yet supported on win64
#          - {icon: 'ğŸŸ¨', sys: 'UCRT64' } #! experimental; simulation with mcode is not yet supported on win64

    defaults:
      run:
        shell: pwsh

    steps:
      - name: 'ğŸ“¥ Download artifact: package'
        uses: actions/download-artifact@v3
        with:
          path: artifact
          name: ${{ matrix.sys }}-zip-win

      - name: 'âš™ Extract package'
        run: |
          dir
          unzip artifact\ghdl-${{matrix.sys}}.zip
          dir

      - name: 'ğŸ›  Set envvars'
        run: |
          $GHDL_DIR = (pwd).Path + '\GHDL\bin'
          echo "GHDL=${GHDL_DIR}\ghdl.exe" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$GHDL_DIR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          dir $GHDL_DIR


      - name: 'ğŸ›  Sanity check'
        run: |
          echo "GHDL is ${env:GHDL}"
          dir ${env:GHDL}
          & ${env:GHDL} version
          echo "sha: ${{github.sha}}"
          echo "head_ref: ${{github.head_ref}}"
          echo "ref_name: ${{github.ref_name}}"

      - name: 'âš™ git config'
        run: |
           dir
           dir ${env:GHDL}
           git config --global core.autocrlf input

      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3
        with:
          path: checkout

      - name: '${{ matrix.icon }} Setup MSYS2'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          update: true
          pacboy: >
            diffutils:p
            gcc:p

      - name: 'ğŸš¦ Testsuite for ghdl'
        shell: msys2 {0}
        run: |
          set -x
          pwd
          ls -l
          echo "PATH: $PATH"
          echo "GHDL: $GHDL"
          cygghdl="$(cygpath -u $GHDL)"
          echo "cyg GHDL: $cygghdl"
          $cygghdl -v
          GHDL="$cygghdl"
          PATH="$PATH:$(dirname $cygghdl)"
          echo "PATH: $PATH"
          ghdl version
          cd checkout
          ./testsuite/testsuite.sh gna

#
# Windows Test of pyGHDL platform wheel
#
  win-test-wheel:
    name: 'ğŸš¦ğŸğŸ¥¡${{ matrix.icon }} ${{ matrix.sys }} (test sa py)'
    runs-on: windows-latest

    needs:
      - win-wheel

    strategy:
      fail-fast: false
      matrix:
        include:
          - {icon: 'ğŸŸª', sys: 'MINGW32', pyarch: x86 }
#          - {icon: 'ğŸŸ¦', sys: 'MINGW64', pyarch: x64 }
          - {icon: 'ğŸŸ¨', sys: 'UCRT64',  pyarch: x64 }

    defaults:
      run:
        shell: pwsh

    steps:
      - name: 'ğŸ Setup Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: ${{ matrix.pyarch }}

      - name: 'ğŸ“¥ Download artifact: package'
        uses: actions/download-artifact@v3
        with:
          path: artifact
          name: ${{ matrix.sys }}-wheel

      - name: 'ğŸ Sanity check of the python wheel'
        run: |
          pip3 install -v (get-item artifact\pyGHDL-*.whl)

      - name: 'âš™ git config'
        run: |
           dir
           dir ${env:GHDL}
           git config --global core.autocrlf input

      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3
        with:
          path: checkout

      - name: 'ğŸš¦ pyunit tests'
        run: |
          pip3 install pytest
          dir checkout
          cd checkout/testsuite
          python3 -m pytest pyunit

#
# Windows MSYS2 Build
#
  msys2:
    name: 'ğŸš§${{ matrix.icon }} ${{ matrix.sys }} ${{ matrix.pkg }} (build)'
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        include:
#          - {icon: 'ğŸŸª', pkg: 'llvm',  sys: 'MINGW32' } ! not yet functional
          - {icon: 'ğŸŸ¦', pkg: 'llvm',  sys: 'MINGW64' }
          - {icon: 'ğŸŸ¨', pkg: 'llvm',  sys: 'UCRT64'  } #! experimental
          - {icon: 'ğŸŸª', pkg: 'mcode', sys: 'MINGW32' }
#          - {icon: 'ğŸŸ¦', pkg: 'mcode', sys: 'MINGW64' } #! simulation with mcode is not yet supported on win64
          - {icon: 'ğŸŸ¨', pkg: 'mcode', sys: 'UCRT64'  } #! experimental; simulation with mcode is not yet supported on win64

    env:
      MINGW_ARCH: ${{ matrix.sys }}
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: '${{ matrix.icon }} Setup MSYS2'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          update: true
          install: base-devel git
          pacboy: toolchain:p

      - name: 'âš™ git config'
        run: git config --global core.autocrlf input
        shell: bash

      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3
        with:
          # The command 'git describe' (used for version) needs the history.
          fetch-depth: 0

      - name: 'ğŸš§ Build package'
        run: |
          cd scripts/msys2-${{ matrix.pkg }}
          makepkg-mingw --noconfirm --noprogressbar -sCLf
          for item in src pkg; do
            tar czf msys2-${{ matrix.pkg }}."$item".tar.gz "$item"
          done

      - name: 'ğŸ“¤ Upload artifact: builddir'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.sys }}-${{ matrix.pkg }}-builddir
          path: |
            scripts/msys2-${{ matrix.pkg }}/msys2-${{ matrix.pkg }}.src.tar.gz
            scripts/msys2-${{ matrix.pkg }}/msys2-${{ matrix.pkg }}.pkg.tar.gz

      - name: 'ğŸ“¤ Upload artifact: package'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.sys }}-${{ matrix.pkg }}
          path: scripts/msys2-${{ matrix.pkg }}/mingw-*ghdl*.pkg.tar.zst
          if-no-files-found: error

#
# Windows MSYS2 Test
#
  msys2-test:
    name: 'ğŸš¦${{ matrix.sys.icon }} ${{ matrix.sys.sys }} ${{ matrix.sys.pkg }} ${{ matrix.suite }}'
    runs-on: windows-latest

    needs:
      - msys2

    strategy:
      fail-fast: false
      matrix:
        sys:
#          - {icon: 'ğŸŸª', pkg: 'llvm',  sys: 'MINGW32' } ! not yet functional
#          - {icon: 'ğŸŸ¦', pkg: 'llvm',  sys: 'MINGW64' }
          - {icon: 'ğŸŸ¨', pkg: 'llvm',  sys: 'UCRT64'  } #! experimental
          - {icon: 'ğŸŸª', pkg: 'mcode', sys: 'MINGW32' }
#          - {icon: 'ğŸŸ¦', pkg: 'mcode', sys: 'MINGW64' } ! simulation with mcode is not yet supported on win64
#          - {icon: 'ğŸŸ¨', pkg: 'mcode', sys: 'UCRT64'  } ! experimental; simulation with mcode is not yet supported on win64

        suite:
          - 'sanity pyunit vpi vhpi'
          - 'gna'
          - 'vests'
          - 'synth'

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: '${{ matrix.sys.icon }} Setup MSYS2'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys.sys }}
          update: true
          pacboy: >
            diffutils:p
            gcc:p
            python-pip:p
            python-setuptools:p

      - name: 'âš™ git config'
        run: git config --global core.autocrlf input
        shell: bash

      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3

      - name: 'ğŸ“¥ Download artifact: package'
        uses: actions/download-artifact@v3
        with:
          path: artifact
          name: ${{ matrix.sys.sys }}-${{ matrix.sys.pkg }}

      - name: 'ğŸ›  Install package and ğŸ Python dependencies'
        run: |
          pacman --noconfirm -U artifact/mingw-w64-*-ghdl-${{ matrix.sys.pkg }}-*.zst
          pip3 install -r testsuite/requirements.txt

      - name: 'ğŸš¦ Test package'
        run: GHDL=ghdl ./testsuite/testsuite.sh ${{ matrix.suite }}

#
# Release
#

  Release:
    name: 'ğŸ“¦ Release'
    runs-on: ubuntu-latest

    needs:
      - doc
      - lin
      - osx
      - win
      - win-wheel
      - win-test
      - msys2-test

    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/master' || contains(github.ref, 'refs/tags/'))

    steps:

      - name: 'ğŸ“¥ Download artifacts'
        if: "!contains(github.ref, 'refs/tags/')"
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      # Do not upload assets to tagged releases
      - name: Set list of files for uploading
        id: files
        shell: python
        run: |
          from os import environ
          list = (
            'None'
            if '${{ github.ref }}'.startswith('refs/tags/') else
            '**/*.zst **/*.tgz **/ghdl-*.zip **/man/ghdl.1'
          )
          with open(environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as gho:
            gho.write(f'list={list}\n')

      # Tagged: create a pre-release or a release (semver)
      # Untagged: update the assets of pre-release 'nightly'
      - uses: pyTooling/Actions/releaser@r0
        with:
          token: ${{ github.token }}
          tag: 'nightly'
          files: ${{ steps.files.outputs.list }}

#
# pyGHDL Coverage (MINGW64)
#

  coverage:
    name: 'ğŸ“ˆ Coverage'
    runs-on: windows-latest

    needs:
      - msys2

    defaults:
      run:
        shell: msys2 {0}

    steps:

      - name: 'ğŸŸª Setup MSYS2'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          pacboy: >
            python-pip:p
            python-setuptools:p

      - name: 'âš™ git config'
        run: git config --global core.autocrlf input
        shell: bash

      - name: 'ğŸ§° Checkout'
        uses: actions/checkout@v3

      - name: 'ğŸ“¥ Download artifact: package'
        uses: actions/download-artifact@v3
        with:
          path: artifact
          name: MINGW64-llvm

      - name: 'ğŸ›  Install package and ğŸ Python dependencies'
        run: |
          pacman --noconfirm -U artifact/mingw-w64-*-ghdl-llvm-*.zst
          pip3 install --disable-pip-version-check -r testsuite/requirements.txt

      - name: 'ğŸš¦ Run tests to generate coverage report'
        run: PYTHONPATH=$(pwd) python3 -m pytest -rA --cov=.. --cov-config=.coveragerc testsuite/pyunit

      - name: Generate XML coverage report
        if: always()
        run: coverage xml

      - name: 'ğŸ“¤ Upload artifact: coverage report'
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage
          path: coverage.xml

#
# Coverage Publish (Ubuntu)
#

  coverage-publish:
    name: 'ğŸ“® Publish coverage report'
    runs-on: ubuntu-latest

    needs:
      - coverage

    if: always() && github.repository == 'ghdl/ghdl' && github.event_name != 'pull_request'

    steps:

      - name: 'ğŸ“¥ Download artifact: coverage report'
        uses: actions/download-artifact@v3
        with:
          path: .
          name: coverage

      - name: CodeCov
        uses: codecov/codecov-action@v3
        with:
          file: coverage.xml
          flags: unittests

      - name: Codacy
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage.xml

#---

# TODO:
# - Re-package a MINGW/MSYS2 package to provide a 'standalone' tarball/zipfile.
#  - https://github.com/ghdl/ghdl/issues/318#issuecomment-286246287
#
# - Add GNAT GPL 32-bit build job with mcode backend
